services:
  # NOTE: used in pipeline, volumes don't work in pipeline
  db:
    image: mariadb:${DB_VERSION}
    container_name: dev_db
    ports:
      - ${DB_PORT}:${DB_PORT}
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      TZ: ${TZ}
    healthcheck:
      test: mariadb-admin ping -u root -p${DB_ROOT_PASSWORD}
      start_period: 10s
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - ./volumes/db/:/var/lib/mysql/
    
  backend:
    depends_on: 
      db: 
        condition: service_healthy
    image: dev_${API_NAME}
    build:
      context: .
      args:
        JAVA_RUNTIME_ARGS: ${JAVA_RUNTIME_ARGS}
    container_name: backend
    # ports: 
    #   - ${PORT}:${PORT}
    environment:
      MAIL_HOST: maildev
      DB_HOST: db
      TZ: ${TZ}
      # uncomment when using https
      # GATEWAY_PROTOCOL: https
    healthcheck:
      test: wget --no-verbose --no-check-certificate --tries=1 --spider http://backend:${PORT}/app-user/check-logged-in || exit 1
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 20s

  maildev:
    image: maildev/maildev
    container_name: dev_maildev
    ports: 
      - ${MAIL_PORT}:${MAIL_PORT}
      - 1080:1080
    environment:
      TZ: ${TZ}
  
  frontend:
    image: dev_code_notes_frontend
    volumes:
      - ./.nginx.local/nginx.local.conf:/etc/nginx/conf.d/default.conf

  gateway:
    image: dev_code_notes_gateway
    ports:
      - ${GATEWAY_PORT}:${GATEWAY_PORT}
    environment:
      # uncomment when using https
      # HTTPS: true
      BACKEND_HOST: backend
      FRONTEND_HOST: frontend
      SSL_CRT_FILE: /app/.ssl/fullchain.pem
      SSL_KEY_FILE: /app/.ssl/privkey.pem
    depends_on:
      - frontend
      - backend
    healthcheck:
      test: wget --no-verbose --no-check-certificate --tries=1 --spider ${GATEWAY_PROTOCOL}://gateway:${GATEWAY_PORT} || exit 1
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 2s
    volumes:
      - ./.ssl/localhost.crt.pem:/app/.ssl/fullchain.pem
      - ./.ssl/localhost.key.pem:/app/.ssl/privkey.pem










  # http://localhost:4004
  zabbix-server:
    image: zabbix/zabbix-server-mysql:latest
    restart: always
    depends_on:
      - db
      - zabbix-agent
    environment:
      DB_SERVER_HOST: db
      DB_SERVER_PORT: ${DB_PORT}
      MYSQL_DATABASE: zabbix
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD} 
      ZBX_STARTREPORTWRITERS: 3 
      ZBX_LISTENPORT: 4002
    ports:
      - 4002:4002 

  zabbix-agent: 
    image: zabbix/zabbix-agent2:7.4-ubuntu-latest
    environment:
      ZBX_LISTENPORT: 4003
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 4002
      
  zabbix-ui: 
    image: zabbix/zabbix-web-nginx-mysql:7.0.21-ubuntu
    restart: always
    depends_on:
      - db
      - zabbix-server
    ports:
      - 4004:8080
    environment:
      DB_SERVER_HOST: db
      DB_SERVER_PORT: ${DB_PORT}
      MYSQL_DATABASE: zabbix
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      PHP_TZ: Europe/Berlin 
      ZBX_SERVER_PORT: 4002
      ZBX_SERVER_HOST: zabbix-server